<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è¤‡æ•°ç”»åƒåˆ‡æ›¿ä»˜ãã‚¹ãƒãƒƒãƒˆæ¡ˆå†…ï¼ˆè‡ªå‹•éŸ³å£°ç‰ˆ + ãƒ­ã‚°è¨˜éŒ²ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: sans-serif; text-align: center; }
    #camera { width: 100vw; height: 100vh; object-fit: cover; position: absolute; top: 0; left: 0; z-index: -1; }
    #info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; z-index: 1; white-space: pre-wrap; }
    #image { position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%); width: 300px; height: 300px; object-fit: contain; display: none; z-index: 1; background: black; }
    .btn { position: absolute; left: 50%; transform: translateX(-50%); background-color: #007BFF; color: white; border: none; padding: 10px 20px; font-size: 14px; border-radius: 8px; cursor: pointer; z-index: 2; display: none; }
    #patternBtn { bottom: 70px; }
    #nextBtn { bottom: 20px; }
    #logBtn { bottom: 120px; display:block; } /* ãƒ­ã‚°è¨˜éŒ²ãƒœã‚¿ãƒ³ */
    #downloadBtn { bottom: 170px; display:block; } /* CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
    .img-nav { position: absolute; bottom: 260px; z-index: 2; font-size: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 5px 15px; cursor: pointer; border-radius: 6px; }
    #prevBtn { left: 10%; }
    #nextImgBtn { right: 10%; }
  </style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<div id="info">ä½ç½®æƒ…å ±å–å¾—ä¸­...</div>
<img id="image" src="" alt="ã‚¹ãƒãƒƒãƒˆç”»åƒ" />

<!-- æ“ä½œç”¨ãƒœã‚¿ãƒ³ -->
<button class="btn" id="patternBtn" onclick="switchPattern()">English</button>
<button class="btn" id="nextBtn" onclick="goToNextSpot()">ã“ã®ã‚¹ãƒãƒƒãƒˆã¯å®Œäº†</button>
<button class="img-nav" id="prevBtn" onclick="showPrevImage()" style="display:none;">â†</button>
<button class="img-nav" id="nextImgBtn" onclick="showNextImage()" style="display:none;">â†’</button>
<button class="btn" id="logBtn" onclick="logCurrentPosition()">ä½ç½®ãƒ­ã‚°è¨˜éŒ²</button>
<button class="btn" id="downloadBtn" onclick="downloadCSV()">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

<audio id="audio" src=""></audio>

<script>
const spots = [
  { name: "å›³æ›¸é¤¨å‰ã‚¹ãƒ­ãƒ¼ãƒ—", lat: 35.691968142452374, lon: 140.0507643569911, radius: 0, images: ["image0.jpeg", "image1.jpeg"], audio: { A: "spot1.ja.mp3", B: "spot1.en.mp3", C: "spot1.ch.mp3" } }, //ã‚¹ãƒ­ãƒ¼ãƒ—å‰
  { name: "ï¼‘ï¼”å·é¤¨å‰ç›´é€²", lat: 35.69245264109913,  lon: 140.05086356956514, radius: 10, images: ["image2.jpeg", "image10.jpeg"], audio: { A: "spot2.ja.mp3", B: "spot2.en.mp3", C: "spot2.ch.mp3" } }, //æ’æ°´æºã®ä¸Š
  { name: "æ›²ãŒã‚Šè§’å·¦", lat:35.69283599175495,  lon:140.05092001888113, radius: 10, images: ["image3.jpeg", "image11.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } }, //é“ã®è‰²ãŒå¤‰ã‚ã‚‹ã¨ã“ã‚
  { name: "æ›²ãŒã‚Šè§’å³ï¼‘", lat: 35.692909781862724,  lon: 140.05024978654654, radius: 10, images: ["image4.jpeg", "image13.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } }, //13å·é¤¨ã®ã¡ã‚‡ã†ã©è§’
  { name: "æ›²ãŒã‚Šè§’å³ï¼’", lat: 35.69334894066289,  lon: 140.05033682451656, radius: 10, images: ["image5.jpeg", "image14.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } }, //13å·é¤¨ã®ã¡ã‚‡ã†ã©è§’
  { name: "æ›²ãŒã‚Šè§’å³ï¼“", lat: 35.69331981781718,  lon: 140.05102244720183, radius: 10, images: ["image6.jpeg", "image15.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } }, //éšæ®µã®å‰ã®æœ¨
  { name: "ç›®çš„åœ°", lat: 35.693014464267506,  lon: 140.0509410980045, radius: 10, images: ["image7.jpeg", "image16.jpeg"], audio: { A: "spot7,8.ja.mp3", B: "spot7,8.en.mp3", C: "spot7,8.ch.mp3" } } //Tå­—ç·šã®äº¤ç‚¹
];

let currentIndex = 0;
let hasEnteredSpot = false;
let currentSpot = null;
let currentPattern = "A";
let imageIndex = 0;

const camera = document.getElementById("camera");
const info = document.getElementById("info");
const image = document.getElementById("image");
const nextBtn = document.getElementById("nextBtn");
const patternBtn = document.getElementById("patternBtn");
const audio = document.getElementById("audio");
const prevBtn = document.getElementById("prevBtn");
const nextImgBtn = document.getElementById("nextImgBtn");

navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
  .then(stream => camera.srcObject = stream)
  .catch(err => alert("ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err));

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function checkProximity(lat, lon) {
  if (currentIndex >= spots.length) {
    info.innerText = "ã™ã¹ã¦ã®ã‚¹ãƒãƒƒãƒˆã‚’é€šéã—ã¾ã—ãŸã€‚";
    hideAllUI();
    return;
  }
  const spot = spots[currentIndex];
  const distance = getDistance(lat, lon, spot.lat, spot.lon);
  const range = spot.radius || 10;

  info.innerText =
    `ç¾åœ¨åœ°: ç·¯åº¦ ${lat.toFixed(6)}, çµŒåº¦ ${lon.toFixed(6)}\n` +
    `æ¬¡ã®ã‚¹ãƒãƒƒãƒˆ: ${spot.name}ï¼ˆ${currentIndex + 1} / ${spots.length}ï¼‰\n` +
    `æ®‹ã‚Šè·é›¢: ${distance.toFixed(1)}m`;

  if (currentIndex >= 1 && !hasEnteredSpot && distance < range) {
    showSpot(spot);
  }
}

function showSpot(spot) {
  currentSpot = spot;
  hasEnteredSpot = true;
  imageIndex = 0;

  audio.src = spot.audio[currentPattern];
  image.src = spot.images[imageIndex];
  image.style.display = "block";
  nextBtn.style.display = "block";
  patternBtn.style.display = "block";
  prevBtn.style.display = spot.images.length > 1 ? "block" : "none";
  nextImgBtn.style.display = spot.images.length > 1 ? "block" : "none";

  audio.loop = true;
  audio.play().catch(e => console.log("è‡ªå‹•å†ç”Ÿã«å¤±æ•—:", e));
}

function switchPattern() {
  const patterns = ["A", "B", "C"];
  const index = patterns.indexOf(currentPattern);
  currentPattern = patterns[(index + 1) % patterns.length];
  updatePatternButtonText();

  if (currentSpot) {
    audio.pause();
    audio.src = currentSpot.audio[currentPattern];
    audio.play().catch(e => console.log("è‡ªå‹•å†ç”Ÿã«å¤±æ•—:", e));
  }
}

function showPrevImage() {
  if (!currentSpot) return;
  imageIndex = (imageIndex - 1 + currentSpot.images.length) % currentSpot.images.length;
  image.src = currentSpot.images[imageIndex];
}

function showNextImage() {
  if (!currentSpot) return;
  imageIndex = (imageIndex + 1) % currentSpot.images.length;
  image.src = currentSpot.images[imageIndex];
}

function updatePatternButtonText() {
  let label = "";
  switch (currentPattern) {
    case "A": label = "English"; break;
    case "B": label = "ä¸­æ–‡"; break;
    case "C": label = "æ—¥æœ¬èª"; break;
  }
  patternBtn.innerText = label;
}

function goToNextSpot() {
  audio.pause();
  currentIndex++;
  hasEnteredSpot = false;
  currentSpot = null;
  hideAllUI();
}

function hideAllUI() {
  image.style.display = "none";
  nextBtn.style.display = "none";
  patternBtn.style.display = "none";
  prevBtn.style.display = "none";
  nextImgBtn.style.display = "none";
}

/* ---- âœ… ãƒ­ã‚°æ©Ÿèƒ½è¿½åŠ  ---- */
let logData = [];

function logCurrentPosition() {
  if (!navigator.geolocation) {
    alert("ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const timestamp = new Date().toISOString();

    if (currentIndex >= spots.length) {
      alert("ã™ã¹ã¦ã®ã‚¹ãƒãƒƒãƒˆã‚’é€šéã—ã¾ã—ãŸ");
      return;
    }
    const spot = spots[currentIndex];
    const distance = getDistance(lat, lon, spot.lat, spot.lon).toFixed(2);

    const logEntry = {
      time: timestamp,
      lat: lat,
      lon: lon,
      nextSpot: spot.name,
      distance: distance
    };

    logData.push(logEntry);
    info.innerText =
      `ğŸ“ãƒ­ã‚°è¨˜éŒ²ã—ã¾ã—ãŸ\nç¾åœ¨åœ°: ${lat.toFixed(6)}, ${lon.toFixed(6)}\n` +
      `æ¬¡ã®ã‚¹ãƒãƒƒãƒˆ(${spot.name})ã¾ã§: ${distance}m`;

    console.log("Log Entry:", logEntry);
  }, err => {
    alert("ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
  }, { enableHighAccuracy: true });
}

function downloadCSV() {
  if (logData.length === 0) {
    alert("ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  let csv = "time,lat,lon,nextSpot,distance(m)\n";
  logData.forEach(entry => {
    csv += `${entry.time},${entry.lat},${entry.lon},${entry.nextSpot},${entry.distance}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "position_log.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ---- âœ… ä½ç½®æƒ…å ±ç›£è¦– ---- */
if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(
    pos => checkProximity(pos.coords.latitude, pos.coords.longitude),
    err => info.innerText = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ",
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

window.onload = () => {
  showSpot(spots[0]); // èµ·å‹•æ™‚ã«æœ€åˆã®ã‚¹ãƒãƒƒãƒˆã‚’è¡¨ç¤º
  updatePatternButtonText();
};
</script>

</body>
</html>
